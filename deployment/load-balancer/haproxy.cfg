# HAProxy Configuration for Voting Platform Load Balancer
# Version: 2.8+

global
    log stdout format raw local0
    maxconn 4096
    daemon

    # Security
    user haproxy
    group haproxy

    # Performance
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch
    
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    
    # Error pages
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Statistics page
frontend stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:admin
    stats show-legends
    stats show-node

# Main frontend
frontend http_front
    bind *:80
    
    # ACLs for routing
    acl is_api path_beg /api
    acl is_health path /health
    
    # Default backend
    default_backend app_servers
    
    # Use app_servers for API calls
    use_backend app_servers if is_api
    use_backend app_servers if is_health

# Application servers backend
backend app_servers
    balance roundrobin
    option httpchk GET /api/health
    http-check expect status 200
    
    # Health check configuration
    default-server inter 5s fall 3 rise 2
    
    # Server definitions
    server app-server-1 app-server-1:3000 check
    server app-server-2 app-server-2:3000 check
    server app-server-3 app-server-3:3000 check
    
    # Connection settings
    timeout server 30s
    timeout connect 5s
    
    # Retry on failure
    retries 3
    option redispatch

# Health check endpoint
frontend health_check
    bind *:8080
    mode http
    monitor-uri /health
    option dontlog-normal
